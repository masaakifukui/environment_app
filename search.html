<!DOCTYPE html>
<html>
<head>
    <title>検索結果</title>
    <link rel="stylesheet" href="./css/style.css">
</head>

<body>
    <div class="search-area">
        <form id="search-form" action="/search" method="get">
          <input type="text" name="q" placeholder="キーワードで検索">
          <button type="submit">
              <span class="search-icon"></span>
          </button>
        </form>
    </div>
    <div class="content-area">
        <div id="rss-feed-category-2">
            <h2>検索結果</h2>
            <div id="results">読み込み中...</div>
            <div class='rss-btn'>
                <a href='./index.html'>戻る</a>
            </div>
        </div>
    </div>

   

    <script>
      const params = new URLSearchParams(window.location.search);
      const query = params.get("q");         // キーワード検索
      const form = document.getElementById("search-form");
      const input = form.querySelector("input[name='q']");
      const resultsDiv = document.getElementById("results");
    
      let allData = [];
    
      // URLパラメータからカテゴリを取得
      function getCategoryFromUrlOrReferrer() {
        const urlParams = new URLSearchParams(window.location.search);
        const categoryStr = urlParams.get("category");

        if (categoryStr && !isNaN(categoryStr)) {
          return Number(categoryStr);
        }

        const ref = document.referrer;
        if (ref) {
          try {
            const refUrl = new URL(ref);
            const refCategoryStr = new URLSearchParams(refUrl.search).get("category");
            if (refCategoryStr && !isNaN(refCategoryStr)) {
              return Number(refCategoryStr);
            }
          } catch (e) {
            return null;
          }
        }

        return null;
      }
    
      const categoryFromParamOrReferrer = Number(getCategoryFromUrlOrReferrer()) || null;
    
      // 表示レンダリング
      function renderResults(data) {
        resultsDiv.innerHTML = "";
    
        if (data.length === 0) {
          resultsDiv.textContent = "一致する結果はありません。";
          return;
        }
    
        const ul = document.createElement("ul");
        data.forEach(item => {
          const li = document.createElement("li");
          li.className = "rss-list";
          li.innerHTML = `
            <a href="${item.link}" target="_blank"><strong>${item.title}</strong></a><br>
            <p>${item.content}</p>
          `;
          ul.appendChild(li);
        });
        resultsDiv.appendChild(ul);
      }
    
      // APIから全データ取得
      function fetchAllData() {
        resultsDiv.textContent = "読み込み中...";
        fetch("https://firstd1project.masaaki.workers.dev/")
          .then(res => res.json())
          .then(data => {
            allData = data;
            applyFilterAndRender();
          })
          .catch(() => {
            resultsDiv.textContent = "データの取得に失敗しました。";
          });
      }
    
      // ✅ キーワード＆カテゴリで絞り込み
      function applyFilterAndRender() {
        // フォーム入力値を優先
        const q = input.value.trim().toLowerCase();

        const filtered = allData.filter(item => {
          const matchKeyword = q
            ? (item.title.toLowerCase().includes(q) || (item.description || "").toLowerCase().includes(q))
            : true;

          const matchCategory = categoryFromParamOrReferrer !== null
            ? Number(item.category) === categoryFromParamOrReferrer
            : true;  // カテゴリなしの場合はすべて通す

          return matchKeyword && matchCategory;
        });

        renderResults(filtered);
      }
    
      // 初期処理
      window.addEventListener("DOMContentLoaded", () => {
        if (query) input.value = query;
        // URLから q を削除して書き換え
        const params = new URLSearchParams(window.location.search);
        params.delete("q");
        const newUrl = `${location.pathname}?${params.toString()}`.replace(/\?$/, "");
        window.history.replaceState({}, "", newUrl);
              fetchAllData();
      });
    
      // フォーム送信時
      form.addEventListener("submit", e => {
        e.preventDefault();
        applyFilterAndRender();
      });
    </script>    

</body>

</html>
